---
# vars file for kubernetes-cluster
k8s_master: '{{ inventory_hostname in groups[k8s_master_group_name] }}'

k8s_components: '{{ k8s_master_components + k8s_worker_components if k8s_master else k8s_worker_components }}'

k8s_pki_key_file : '{{inventory_hostname}}{{k8s_pki_key_suffix}}'
k8s_pki_key_src: '{{k8s_src_pki_dir}}/{{k8s_pki_key_file}}'
k8s_pki_key_dest : '{{k8s_dest_pki_dir}}/{{k8s_pki_key_file}}'

k8s_pki_cert_file : '{{inventory_hostname}}{{k8s_pki_cert_suffix}}'
k8s_pki_cert_src: '{{k8s_src_pki_dir}}/{{k8s_pki_cert_file}}'
k8s_pki_cert_dest : '{{k8s_dest_pki_dir}}/{{k8s_pki_cert_file}}'

k8s_pki_ca_file : 'ca{{k8s_pki_cert_suffix}}'
k8s_pki_ca_cert_src: '{{k8s_src_pki_dir}}/{{k8s_pki_ca_file}}'
k8s_pki_ca_cert_dest : '{{k8s_dest_pki_dir}}/{{k8s_pki_ca_file}}'

k8s_etcd_prefix: '{% if k8s_secured %}https{% else %}http{% endif %}'
k8s_etcd_servers: '{% for h in groups["etcd-master"] %}{{k8s_etcd_prefix}}://{{h}}:2379{% if not loop.last %},{% endif %}{% endfor %}'

k8s_public_ipv4: '{{ hostvars[inventory_hostname]["ansible_" + k8s_network_iface]["ipv4"]["address"]}}'
k8s_kubelet_address: '{{k8s_public_ipv4}}'
k8s_kube_controller_manager_address: '{{k8s_public_ipv4}}'
k8s_kube_proxy_address: '{{k8s_public_ipv4}}'
k8s_kube_scheduler_address: '{{k8s_public_ipv4}}'

k8s_apiserver_prefix: '{% if k8s_secured %}https{% else %}http{% endif %}'
k8s_apiserver_storage_backend: '--storage-backend {{k8s_apiserver_etcd_backend}}'
k8s_apiserver_etcd_tls: '{% if k8s_secured %}--etcd-cafile {{k8s_pki_ca_cert_dest}} --etcd-certfile {{k8s_pki_cert_dest}} --etcd-keyfile {{k8s_pki_key_dest}}{% endif %}'
k8s_apiserver_tls: '{% if k8s_secured %}--tls-ca-file {{k8s_pki_ca_cert_dest}} --tls-cert-file {{k8s_pki_cert_dest}} --tls-private-key-file {{k8s_pki_key_dest}}{% endif %}'
k8s_apiserver_kubelet_tls: '{% if k8s_secured %}--kubelet-https --kubelet-certificate-authority {{k8s_pki_ca_cert_dest}} --kubelet-client-certificate {{k8s_pki_cert_dest}} --kubelet-client-key {{k8s_pki_key_dest}}{% endif %}'
k8s_apiserver_token_auth: '--token_auth_file={{k8s_conf_dir}}/kube-apiserver-known-tokens.csv'
k8s_apiserver_args: '{{k8s_apiserver_storage_backend}} {{k8s_apiserver_etcd_tls}} {{k8s_apiserver_tls}} {{k8s_apiserver_kubelet_tls}} {{k8s_apiserver_token_auth}} --kubelet-preferred-address-types={{k8s_apiserver_kubelet_address_types | join(",")}}'

k8s_apiserver_secure_addresses: "{% for m in groups[k8s_master_group_name] %}{{k8s_apiserver_prefix}}://{{hostvars[m]['ansible_' + hostvars[m]['k8s_network_iface']]['ipv4']['address']}}:{{k8s_apiserver_secure_port}}{% if not loop.last %},{% endif %}{% endfor %}"
k8s_apiserver_first_master: '{{groups[k8s_master_group_name][0]}}'
k8s_apiserver_secure_lb_eff: "{% if k8s_apiserver_secure_lb is defined %}{{k8s_apiserver_secure_lb}}{% else %}{{k8s_apiserver_prefix}}://{{hostvars[k8s_apiserver_first_master]['ansible_' + k8s_network_iface]['ipv4']['address']}}:{{k8s_apiserver_secure_port}}{% else %}{% endif %}"

k8s_kubelet_tls: '{% if k8s_secured %}--tls-cert-file {{k8s_pki_cert_dest}} --tls-private-key-file {{k8s_pki_key_dest}}{% endif %}'

k8s_kubelet_args: >-
  --node-ip {{k8s_public_ipv4}}
  {{k8s_kubelet_tls}}
  --register-schedulable=true
  --api-servers={{k8s_apiserver_secure_addresses}}
  --cluster_dns={{k8s_cluster_dns}}
  --cluster_domain={{k8s_cluster_domain}}

k8s_kube_controller_manager_args: '{% if k8s_secured %}--root-ca-file={{k8s_pki_ca_cert_dest}} --service-account-private-key-file={{k8s_pki_key_dest}}{% endif %} --leader-elect=true'

k8s_kube_proxy_args: ''

k8s_kube_scheduler_args: '--leader-elect=true'
