#!/usr/bin/env bash
TARGET_CONFIG=$1
KUBECTL_CONFIG="{{k8s_install_dir}}/kubectl --kubeconfig=$TARGET_CONFIG config"

$KUBECTL_CONFIG \
	set-cluster {{k8s_cluster_name}} \
	--certificate-authority={{k8s_pki_ca_cert_dest}} \
	--server={{k8s_apiserver_prefix}}://{{hostvars[k8s_apiserver_first_master]['ansible_' + k8s_network_iface]['ipv4']['address']}}:{{k8s_apiserver_secure_port}}

$KUBECTL_CONFIG \
	set-credentials {{k8s_user}} \
	--client-certificate={{k8s_pki_cert_dest}} \
	--client-key={{k8s_pki_key_dest}} \
	--token=$K8S_APISERVER_TOKEN

$KUBECTL_CONFIG \
	set-context {{k8s_context_name}} \
	--cluster={{k8s_cluster_name}} \
	--user={{k8s_user}}

$KUBECTL_CONFIG \
	use-context \
	{{k8s_context_name}}
