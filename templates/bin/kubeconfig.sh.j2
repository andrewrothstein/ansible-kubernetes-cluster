#!/usr/bin/env bash
TARGET_CONFIG=$1
KUBECTL_CONFIG="{{k8s_install_dir}}/kubectl --kubeconfig $TARGET_CONFIG config"
$KUBECTL_CONFIG \
	set-cluster {{k8s_cluster_name}} \
	--server={{k8s_apiserver_first_master}} \
	--insecure-skip-tls-verify=true

$KUBECTL_CONFIG \
	unset clusters

$KUBECTL_CONFIG \
	set-cluster mykubecluster \
	--certificate-authority={{k8s_pki_ca_cert_dest}} \
	--embed-certs=true \
	--server={{k8s_apiserver_first_master}}

$KUBECTL_CONFIG \
	set-credentials kubelet \
	--client-certificate={{k8s_pki_cert_dest}} \
	--client-key={{k8s_pki_key_dest}} \
	--embed-certs=true \
	--token={{k8s_apiserver_token}}

$KUBECTL_CONFIG \
	set-context service-account-context \
	--cluster=mykubecluster \
	--user=kubelet

$KUBECTL_CONFIG \
	use-context \
	service-account-context
